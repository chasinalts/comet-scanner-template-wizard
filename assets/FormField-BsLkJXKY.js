var q=Object.defineProperty;var D=(e,t,r)=>t in e?q(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var j=(e,t,r)=>D(e,typeof t!="symbol"?t+"":t,r);import{a as m}from"./vendor-react-Cmwg8GZL.js";import{S as w,s as S,h as Q}from"./index-DSA3-jpL.js";import{j as h,m as A}from"./vendor-ui-Bq_-EsXc.js";class _{constructor(t=100){j(this,"cache");j(this,"maxSize");this.cache=new Map,this.maxSize=t}get(t){const r=this.cache.get(t);if(r){if(r.expiry&&Date.now()>r.expiry){this.cache.delete(t);return}return this.cache.delete(t),this.cache.set(t,r),r.value}}set(t,r,a=null){if(this.cache.size>=this.maxSize){const s=this.cache.keys().next().value;s&&this.cache.delete(s)}const o=a?Date.now()+a:null;this.cache.set(t,{value:r,expiry:o})}clear(){this.cache.clear()}}function I(e,t={}){const{maxCacheSize:r=100,ttl:a=null}=t,o=new _(r),s=(...n)=>{const c=JSON.stringify(n),d=o.get(c);if(d!==void 0)return d;const l=e(...n);return l instanceof Promise?(o.set(c,l,a),l.then(g=>(o.set(c,g,a),g)).catch(g=>{throw o.get(c)===l&&o.set(c,void 0,0),g})):(o.set(c,l,a),l)};return s.clearCache=()=>{o.clear()},s}const ce=()=>{const[e,t]=m.useState([]),[r,a]=m.useState(!0),[o,s]=m.useState({bannerImages:[],scannerImages:[]});m.useEffect(()=>{const u=async()=>{a(!0);const b=localStorage.getItem("admin_contents");if(b)try{t(JSON.parse(b))}catch(x){console.error("Error parsing saved contents:",x)}try{console.log("Fetching images from Supabase Storage..."),console.log("Supabase URL:",supabaseUrl),console.log("Storage bucket:",w);const{data:x,error:$}=await S.storage.from(w).list("banner");$?console.error("Error fetching banner images:",$):console.log("Banner files fetched successfully:",x?.length||0);const{data:C,error:M}=await S.storage.from(w).list("scanner");M?console.error("Error fetching scanner images:",M):console.log("Scanner files fetched successfully:",C?.length||0);const z=[];if(x&&x.length>0)for(const U of x){const{data:R}=await S.storage.from(w).createSignedUrl(`banner/${U.name}`,3600);R?.signedUrl&&z.push({id:U.id||U.name,src:R.signedUrl,alt:"Banner Image",scale:1,displayText:""})}const F=[];if(C&&C.length>0)for(const U of C){const{data:R}=await S.storage.from(w).createSignedUrl(`scanner/${U.name}`,3600);R?.signedUrl&&F.push({id:U.id||U.name,src:R.signedUrl,alt:"Scanner Image",scale:1,displayText:""})}s({bannerImages:z,scannerImages:F}),console.log("Loaded from Supabase Storage:",{bannerImages:z.length,scannerImages:F.length})}catch(x){console.error("Error loading images from Supabase Storage:",x)}a(!1)};u();const i=b=>{b.key==="admin_contents"&&u()};return window.addEventListener("storage",i),()=>window.removeEventListener("storage",i)},[]);const n=m.useMemo(()=>I(u=>u.filter(i=>i.type==="banner")),[]),c=m.useCallback(()=>{const u=n(e);if(u.length>0){const i=u[u.length-1];return{id:i.id,src:i.imageUrl||"",alt:i.title,scale:i.scale,displayText:i.displayText}}return o.bannerImages.length>0?o.bannerImages[0]:null},[e,n,o.bannerImages]),d=m.useMemo(()=>I(u=>u.filter(i=>i.type==="scanner")),[]),l=m.useMemo(()=>I(u=>[...u].sort((i,b)=>b.updatedAt-i.updatedAt)),[]),g=m.useMemo(()=>I(u=>u.map(i=>({id:i.id,src:i.imageUrl||"",alt:i.title,scale:i.scale,displayText:i.displayText}))),[]),p=m.useCallback(()=>{const u=d(e),i=l(u),b=g(i);return b.length>0?b:o.scannerImages},[e,d,l,g,o.scannerImages]),v=m.useMemo(()=>I(u=>u.filter(i=>i.type==="template")),[]),y=m.useMemo(()=>I(u=>u.map(i=>({id:i.id,title:i.title,code:i.content}))),[]),E=m.useCallback(()=>{const u=v(e),i=l(u);return y(i)},[e,v,l,y]),k=m.useMemo(()=>I(u=>u.filter(i=>i.type==="question")),[]),O=m.useMemo(()=>I(u=>u.map(i=>({id:i.id,title:i.title,text:i.content}))),[]),T=m.useCallback(()=>{const u=k(e),i=l(u);return O(i)},[e,k,l,O]);return m.useMemo(()=>({getBannerImage:c,getScannerImages:p,getTemplates:E,getQuestions:T,hasContent:e.length>0||o.bannerImages.length>0||o.scannerImages.length>0,isLoading:r}),[c,p,E,T,e.length,o.bannerImages.length,o.scannerImages.length,r])},f=[];for(let e=0;e<256;++e)f.push((e+256).toString(16).slice(1));function J(e,t=0){return(f[e[t+0]]+f[e[t+1]]+f[e[t+2]]+f[e[t+3]]+"-"+f[e[t+4]]+f[e[t+5]]+"-"+f[e[t+6]]+f[e[t+7]]+"-"+f[e[t+8]]+f[e[t+9]]+"-"+f[e[t+10]]+f[e[t+11]]+f[e[t+12]]+f[e[t+13]]+f[e[t+14]]+f[e[t+15]]).toLowerCase()}let N;const V=new Uint8Array(16);function K(){if(!N){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");N=crypto.getRandomValues.bind(crypto)}return N(V)}const Y=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),P={randomUUID:Y};function G(e,t,r){if(P.randomUUID&&!e)return P.randomUUID();e=e||{};const a=e.random??e.rng?.()??K();if(a.length<16)throw new Error("Random bytes length must be >= 16");return a[6]=a[6]&15|64,a[8]=a[8]&63|128,J(a)}const B=async()=>{try{const{data:{user:e}}=await S.auth.getUser();if(!e)return!1;const{data:t,error:r}=await S.from("user_profiles").select("is_owner").eq("id",e.id).single();return r||!t?(console.error("Error checking owner status:",r),!1):t.is_owner===!0}catch(e){return console.error("Error checking owner status:",e),!1}},H=async(e,t,r="public, max-age=31536000")=>{try{const a=Q();if(!a)throw new Error("Authentication required. Please sign in to upload files.");if(!await B())throw new Error("You do not have permission to upload files. Only owners can upload media.");const s=e.name.split(".").pop(),n=`${G()}.${s}`,c=`${t}/${n}`,d=S.storage.from(w),{data:l,error:g}=await d.upload(c,e,{cacheControl:r,upsert:!1,contentType:e.type,duplex:"half",metadata:{userId:a}});if(g)throw console.error("Error uploading file to Supabase Storage:",g),g;const{data:{signedUrl:p}}=await S.storage.from(w).createSignedUrl(l.path,60*60*24*365);if(!p)throw new Error("Failed to generate signed URL for uploaded file");return console.log("File uploaded successfully to Supabase Storage:",p),p}catch(a){throw console.error("Error uploading file to Supabase Storage:",a),a}},X=async e=>{try{if(!Q())throw new Error("Authentication required. Please sign in to delete files.");if(!await B())throw new Error("You do not have permission to delete files. Only owners can manage media.");const o=new URL(e).pathname.split("/"),s=o.findIndex(l=>l===w);if(s===-1||s===o.length-1){console.error("Invalid Supabase Storage URL format:",e);return}const n=o.slice(s+1).join("/"),c=S.storage.from(w),{error:d}=await c.remove([n]);if(d)throw console.error("Error deleting file from Supabase Storage:",d),d;console.log("File deleted successfully from Supabase Storage:",n)}catch(t){throw console.error("Error deleting file from Supabase Storage:",t),t}},Z=async(e,t=1920,r=1080,a=.8)=>new Promise((o,s)=>{try{const n=new FileReader;n.onload=c=>{const d=new Image;d.onload=()=>{let l=d.width,g=d.height;if(l>t||g>r){const y=Math.min(t/l,r/g);l=Math.floor(l*y),g=Math.floor(g*y)}const p=document.createElement("canvas");p.width=l,p.height=g;const v=p.getContext("2d");if(!v){s(new Error("Could not get canvas context"));return}v.drawImage(d,0,0,l,g),p.toBlob(y=>{if(!y){s(new Error("Could not create blob from canvas"));return}const E=new File([y],e.name,{type:e.type,lastModified:Date.now()});console.log("Image compression results:",{originalSize:e.size,compressedSize:E.size,compressionRatio:(E.size/e.size*100).toFixed(2)+"%",dimensions:`${l}x${g}`}),o(E)},e.type,a)},d.onerror=()=>{s(new Error("Failed to load image for compression"))},typeof c.target?.result=="string"?d.src=c.target.result:s(new Error("Failed to read file"))},n.onerror=()=>{s(new Error("Failed to read file"))},n.readAsDataURL(e)}catch(n){s(n)}}),W=(e,t=1)=>{const r=t*1024*1024;return e.size>r},ee=async(e,t={maxWidth:1920,maxHeight:1080,quality:.8,maxSizeInMB:1})=>{try{const r=W(e,t.maxSizeInMB)?t.quality:.92;return console.log(`Processing image with quality: ${r}`),await Z(e,t.maxWidth,t.maxHeight,r)}catch(r){return console.error("Error processing image, using original:",r),e}},ie=(e,t,r,a)=>{try{const o=URL.createObjectURL(e);(async()=>{try{const s=await ee(e,{maxWidth:1920,maxHeight:1080,quality:.85,maxSizeInMB:1}),c=await H(s,t);console.log("Image uploaded to Supabase:",{originalSize:e.size,processedSize:s.size,compressionRatio:(s.size/e.size*100).toFixed(2)+"%",imageUrl:c}),r(c,o),setTimeout(()=>{URL.revokeObjectURL(o)},5e3)}catch(s){if(console.error("Error in image processing or upload:",s),URL.revokeObjectURL(o),a)a(s);else throw s}})()}catch(o){if(console.error("Error in handleSupabaseImageUpload:",o),a)a(o);else throw o}},te=async(e,t=!1)=>{if(e.startsWith("blob:"))URL.revokeObjectURL(e);else if(t)try{e.includes("supabase")&&await X(e)}catch(r){console.error("Error deleting file from Supabase Storage:",r)}},le=(e,t,r)=>new Promise((a,o)=>{const s=new Image;s.src=URL.createObjectURL(e),s.onload=()=>{let n=s.width,c=s.height;n>t&&(c=c*t/n,n=t),c>r&&(n=n*r/c,c=r);const d=document.createElement("canvas");d.width=n,d.height=c;const l=d.getContext("2d");if(!l){o(new Error("Could not get canvas context"));return}l.drawImage(s,0,0,n,c),d.toBlob(g=>{g?a(g):o(new Error("Could not create blob from canvas"))},e.type),URL.revokeObjectURL(s.src)},s.onerror=()=>{o(new Error("Failed to load image")),URL.revokeObjectURL(s.src)}}),de=()=>{const[e,t]=m.useState(()=>{const s=localStorage.getItem("admin_questions");return s?JSON.parse(s):[]});return m.useEffect(()=>{localStorage.setItem("admin_questions",JSON.stringify(e))},[e]),m.useEffect(()=>()=>{e.forEach(s=>{s.options?.forEach(n=>{n.imagePreview&&te(n.imagePreview)})})},[e]),{questions:e,setQuestions:t,addQuestion:s=>{const n={id:`question-${Date.now()}`,type:s,text:"",required:!1,...s==="choice"&&{options:[]},...s==="text"&&{placeholderVariable:""}};t(c=>[...c,n])},updateQuestion:(s,n)=>{t(c=>c.map(d=>d.id===s?{...d,...n}:d))},deleteQuestion:s=>{t(n=>n.filter(c=>c.id!==s))}}},ue=()=>{const[e,t]=m.useState(()=>{const n=localStorage.getItem("admin_sections");return n?JSON.parse(n):[]});return m.useEffect(()=>{localStorage.setItem("admin_sections",JSON.stringify(e))},[e]),{sections:e,setSections:t,addSection:()=>{const n={id:`section-${Date.now()}`,title:"New Section",code:"",isMandatory:!1};t(c=>[...c,n])},updateSection:(n,c)=>{t(d=>d.map(l=>l.id===n?{...l,...c}:l))},deleteSection:n=>{t(c=>c.filter(d=>d.id!==n))},reorderSections:n=>{t(n)}}},L=({label:e,error:t,helperText:r,required:a,children:o,fullWidth:s=!1})=>h.jsxs("div",{className:`${s?"w-full":""} space-y-1`,children:[e&&h.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:[e,a&&h.jsx("span",{className:"text-red-500 ml-1",children:"*"})]}),h.jsx("div",{className:"mt-1",children:o}),(t||r)&&h.jsx("div",{className:"mt-1",children:t?h.jsx(A.p,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:"text-sm text-red-600",children:t}):r?h.jsx("p",{className:"text-sm text-gray-500",children:r}):null})]}),ge=({label:e,error:t,helperText:r,required:a,fullWidth:o,...s})=>h.jsx(L,{label:e,error:t,helperText:r,required:a,fullWidth:o,children:h.jsx("input",{className:`
          block rounded-md shadow-sm
          ${o?"w-full":"w-auto"}
          ${t?"border-red-500 focus:ring-red-500 focus:border-red-500":"border-gray-300 focus:ring-blue-500 focus:border-blue-500"}
          disabled:bg-gray-50 disabled:text-gray-500
        `,...s})}),me=({label:e,error:t,helperText:r,required:a,fullWidth:o,...s})=>h.jsx(L,{label:e,error:t,helperText:r,required:a,fullWidth:o,children:h.jsx("textarea",{className:`
          block rounded-md shadow-sm
          ${o?"w-full":"w-auto"}
          ${t?"border-red-500 focus:ring-red-500 focus:border-red-500":"border-gray-300 focus:ring-blue-500 focus:border-blue-500"}
          disabled:bg-gray-50 disabled:text-gray-500
        `,...s})}),he=({label:e,error:t,helperText:r,required:a,fullWidth:o,children:s,...n})=>h.jsx(L,{label:e,error:t,helperText:r,required:a,fullWidth:o,children:h.jsx("select",{className:`
          block rounded-md shadow-sm
          ${o?"w-full":"w-auto"}
          ${t?"border-red-500 focus:ring-red-500 focus:border-red-500":"border-gray-300 focus:ring-blue-500 focus:border-blue-500"}
          disabled:bg-gray-50 disabled:text-gray-500
        `,...n,children:s})}),fe=({label:e,error:t,helperText:r,required:a,...o})=>h.jsx(L,{error:t,helperText:r,required:a,children:h.jsxs("div",{className:"flex items-center",children:[h.jsx("input",{type:"checkbox",className:`
            rounded border-gray-300 text-blue-600 shadow-sm
            focus:border-blue-300 focus:ring focus:ring-offset-0 focus:ring-blue-200 focus:ring-opacity-50
            ${t?"border-red-500":""}
          `,...o}),e&&h.jsxs("label",{className:"ml-2 block text-sm text-gray-900",children:[e,a&&h.jsx("span",{className:"text-red-500 ml-1",children:"*"})]})]})});export{fe as C,he as S,ge as T,de as a,ue as b,te as c,me as d,ie as h,B as i,I as m,le as r,ce as u};
