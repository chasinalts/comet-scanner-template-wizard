var L=Object.defineProperty;var T=(e,t,o)=>t in e?L(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;var I=(e,t,o)=>T(e,typeof t!="symbol"?t+"":t,o);import{a as p}from"./vendor-react-Dyhn-Q9i.js";import{s as U,d as C,S as v,L as k}from"./index-BegOODW_.js";import{j as m,m as N}from"./vendor-ui-Bp3seDoC.js";class O{constructor(t=100){I(this,"cache");I(this,"maxSize");this.cache=new Map,this.maxSize=t}get(t){const o=this.cache.get(t);if(o){if(o.expiry&&Date.now()>o.expiry){this.cache.delete(t);return}return this.cache.delete(t),this.cache.set(t,o),o.value}}set(t,o,n=null){if(this.cache.size>=this.maxSize){const s=this.cache.keys().next().value;s&&this.cache.delete(s)}const r=n?Date.now()+n:null;this.cache.set(t,{value:o,expiry:r})}clear(){this.cache.clear()}}function y(e,t={}){const{maxCacheSize:o=100,ttl:n=null}=t,r=new O(o),s=(...a)=>{const c=JSON.stringify(a),l=r.get(c);if(l!==void 0)return l;const d=e(...a);return d instanceof Promise?(r.set(c,d,n),d.then(g=>(r.set(c,g,n),g)).catch(g=>{throw r.get(c)===d&&r.set(c,void 0,0),g})):(r.set(c,d,n),d)};return s.clearCache=()=>{r.clear()},s}const Z=()=>{const[e,t]=p.useState([]);p.useEffect(()=>{const u=()=>{const S=localStorage.getItem("admin_contents");S&&t(JSON.parse(S))};u();const i=S=>{S.key==="admin_contents"&&u()};return window.addEventListener("storage",i),()=>window.removeEventListener("storage",i)},[]);const o=p.useMemo(()=>y(u=>u.filter(i=>i.type==="banner")),[]),n=p.useCallback(()=>{const u=o(e);if(u.length===0)return null;const i=u[u.length-1];return{id:i.id,src:i.imageUrl||"",alt:i.title,scale:i.scale,displayText:i.displayText}},[e,o]),r=p.useMemo(()=>y(u=>u.filter(i=>i.type==="scanner")),[]),s=p.useMemo(()=>y(u=>[...u].sort((i,S)=>S.updatedAt-i.updatedAt)),[]),a=p.useMemo(()=>y(u=>u.map(i=>({id:i.id,src:i.imageUrl||"",alt:i.title,scale:i.scale,displayText:i.displayText}))),[]),c=p.useCallback(()=>{const u=r(e),i=s(u);return a(i)},[e,r,s,a]),l=p.useMemo(()=>y(u=>u.filter(i=>i.type==="template")),[]),d=p.useMemo(()=>y(u=>u.map(i=>({id:i.id,title:i.title,code:i.content,isFullTemplate:i.isFullTemplate}))),[]),g=p.useCallback(()=>{const u=l(e),i=s(u);return d(i)},[e,l,s,d]),f=p.useCallback(()=>({code:localStorage.getItem("fullTemplateCode")||"",isEnabled:localStorage.getItem("fullTemplateEnabled")==="true"}),[]),x=p.useMemo(()=>y(u=>u.filter(i=>i.type==="question")),[]),b=p.useMemo(()=>y(u=>u.map(i=>({id:i.id,title:i.title,text:i.content}))),[]),w=p.useCallback(()=>{const u=x(e),i=s(u);return b(i)},[e,x,s,b]);return p.useMemo(()=>({getBannerImage:n,getScannerImages:c,getTemplates:g,getFullTemplate:f,getQuestions:w,hasContent:e.length>0}),[n,c,g,f,w,e.length])},h=[];for(let e=0;e<256;++e)h.push((e+256).toString(16).slice(1));function M(e,t=0){return(h[e[t+0]]+h[e[t+1]]+h[e[t+2]]+h[e[t+3]]+"-"+h[e[t+4]]+h[e[t+5]]+"-"+h[e[t+6]]+h[e[t+7]]+"-"+h[e[t+8]]+h[e[t+9]]+"-"+h[e[t+10]]+h[e[t+11]]+h[e[t+12]]+h[e[t+13]]+h[e[t+14]]+h[e[t+15]]).toLowerCase()}let j;const B=new Uint8Array(16);function Q(){if(!j){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");j=crypto.getRandomValues.bind(crypto)}return j(B)}const P=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),R={randomUUID:P};function D(e,t,o){if(R.randomUUID&&!e)return R.randomUUID();e=e||{};const n=e.random??e.rng?.()??Q();if(n.length<16)throw new Error("Random bytes length must be >= 16");return n[6]=n[6]&15|64,n[8]=n[8]&63|128,M(n)}const z=async()=>{try{const{data:{user:e}}=await U.auth.getUser();if(!e)return!1;const{data:t,error:o}=await U.from("user_profiles").select("is_owner").eq("id",e.id).single();return o||!t?(console.error("Error checking owner status:",o),!1):t.is_owner===!0}catch(e){return console.error("Error checking owner status:",e),!1}},q=async(e,t,o="public, max-age=31536000")=>{try{const n=C();if(!n)throw new Error("Authentication required. Please sign in to upload files.");if(!await z())throw new Error("You do not have permission to upload files. Only owners can upload media.");const s=e.name.split(".").pop(),a=`${D()}.${s}`,c=`${t}/${a}`,l=U.storage.from(v),{data:d,error:g}=await l.upload(c,e,{cacheControl:o,upsert:!1,contentType:e.type,duplex:"half",metadata:{userId:n}});if(g)throw console.error("Error uploading file to Supabase Storage:",g),g;const{data:{signedUrl:f}}=await U.storage.from(v).createSignedUrl(d.path,60*60*24*365);if(!f)throw new Error("Failed to generate signed URL for uploaded file");return console.log("File uploaded successfully to Supabase Storage:",f),f}catch(n){throw console.error("Error uploading file to Supabase Storage:",n),n}},A=async e=>{try{if(!C())throw new Error("Authentication required. Please sign in to delete files.");if(!await z())throw new Error("You do not have permission to delete files. Only owners can manage media.");const r=new URL(e).pathname.split("/"),s=r.findIndex(d=>d===v);if(s===-1||s===r.length-1){console.error("Invalid Supabase Storage URL format:",e);return}const a=r.slice(s+1).join("/"),c=U.storage.from(v),{error:l}=await c.remove([a]);if(l)throw console.error("Error deleting file from Supabase Storage:",l),l;console.log("File deleted successfully from Supabase Storage:",a)}catch(t){throw console.error("Error deleting file from Supabase Storage:",t),t}},_=async(e,t=1920,o=1080,n=.8)=>new Promise((r,s)=>{try{const a=new FileReader;a.onload=c=>{const l=new Image;l.onload=()=>{let{width:d,height:g}=l;if(d>t||g>o){const b=Math.min(t/d,o/g);d=Math.floor(d*b),g=Math.floor(g*b)}const f=document.createElement("canvas");f.width=d,f.height=g;const x=f.getContext("2d");if(!x){s(new Error("Could not get canvas context"));return}x.drawImage(l,0,0,d,g),f.toBlob(b=>{if(!b){s(new Error("Could not create blob from canvas"));return}const w=new File([b],e.name,{type:e.type,lastModified:Date.now()});console.log("Image compression:",{originalSize:e.size,compressedSize:w.size,ratio:`${(w.size/e.size*100).toFixed(0)}%`,dimensions:`${d}x${g}`}),r(w)},e.type,n)},l.onerror=()=>s(new Error("Failed to load image")),typeof c.target?.result=="string"?l.src=c.target.result:s(new Error("Failed to read file"))},a.onerror=()=>s(new Error("Failed to read file")),a.readAsDataURL(e)}catch(a){s(a)}}),J=async(e,t={maxWidth:1920,maxHeight:1080,quality:.8,maxSizeInMB:1})=>{try{const o=t.maxSizeInMB*1024*1024,r=e.size>o?t.quality:.92;return await _(e,t.maxWidth,t.maxHeight,r)}catch(o){return console.error("Error processing image, using original:",o),e}},W=(e,t,o,n)=>{try{const r=URL.createObjectURL(e);(async()=>{try{const s=await J(e,{maxWidth:1920,maxHeight:1080,quality:.85,maxSizeInMB:1}),c=await q(s,t);console.log("Image uploaded to Supabase:",{originalSize:e.size,processedSize:s.size,compressionRatio:(s.size/e.size*100).toFixed(2)+"%",imageUrl:c}),o(c,r),setTimeout(()=>{URL.revokeObjectURL(r)},5e3)}catch(s){if(console.error("Error in image processing or upload:",s),URL.revokeObjectURL(r),n)n(s);else throw s}})()}catch(r){if(console.error("Error in handleSupabaseImageUpload:",r),n)n(r);else throw r}},V=async(e,t=!1)=>{if(e.startsWith("blob:"))URL.revokeObjectURL(e);else if(t)try{e.includes("supabase")&&await A(e)}catch(o){console.error("Error deleting file from Supabase Storage:",o)}},ee=(e,t,o)=>new Promise((n,r)=>{const s=new Image;s.src=URL.createObjectURL(e),s.onload=()=>{let a=s.width,c=s.height;a>t&&(c=c*t/a,a=t),c>o&&(a=a*o/c,c=o);const l=document.createElement("canvas");l.width=a,l.height=c;const d=l.getContext("2d");if(!d){r(new Error("Could not get canvas context"));return}d.drawImage(s,0,0,a,c),l.toBlob(g=>{g?n(g):r(new Error("Could not create blob from canvas"))},e.type),URL.revokeObjectURL(s.src)},s.onerror=()=>{r(new Error("Failed to load image")),URL.revokeObjectURL(s.src)}}),te=()=>{const[e,t]=p.useState(()=>{const s=localStorage.getItem("admin_questions");return s?JSON.parse(s):[]});return p.useEffect(()=>{localStorage.setItem("admin_questions",JSON.stringify(e))},[e]),p.useEffect(()=>()=>{e.forEach(s=>{s.options?.forEach(a=>{a.imagePreview&&V(a.imagePreview)})})},[e]),{questions:e,setQuestions:t,addQuestion:s=>{const a={id:`question-${Date.now()}`,type:s,text:"",required:!1,...s==="choice"&&{options:[]},...s==="text"&&{placeholderVariable:""}};t(c=>[...c,a])},updateQuestion:(s,a)=>{t(c=>c.map(l=>l.id===s?{...l,...a}:l))},deleteQuestion:s=>{t(a=>a.filter(c=>c.id!==s))}}},se=()=>{const[e,t]=p.useState(()=>{const a=localStorage.getItem("admin_sections");return a?JSON.parse(a):[]});return p.useEffect(()=>{localStorage.setItem("admin_sections",JSON.stringify(e))},[e]),{sections:e,setSections:t,addSection:()=>{const a={id:`section-${Date.now()}`,title:"New Section",code:"",isMandatory:!1};t(c=>[...c,a])},updateSection:(a,c)=>{t(l=>l.map(d=>d.id===a?{...d,...c}:d))},deleteSection:a=>{t(c=>c.filter(l=>l.id!==a))},reorderSections:a=>{t(a)}}},E=({label:e,error:t,helperText:o,required:n,children:r,fullWidth:s=!1})=>m.jsxs("div",{className:`${s?"w-full":""} space-y-1`,children:[e&&m.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:[e,n&&m.jsx("span",{className:"text-red-500 ml-1",children:"*"})]}),m.jsx("div",{className:"mt-1",children:r}),(t||o)&&m.jsx("div",{className:"mt-1",children:t?m.jsx(N.p,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:"text-sm text-red-600",children:t}):o?m.jsx("p",{className:"text-sm text-gray-500",children:o}):null})]}),oe=({label:e,error:t,helperText:o,required:n,fullWidth:r,...s})=>m.jsx(E,{label:e,error:t,helperText:o,required:n,fullWidth:r,children:m.jsx("input",{className:`
          block rounded-md shadow-sm
          ${r?"w-full":"w-auto"}
          ${t?"border-red-500 focus:ring-red-500 focus:border-red-500":"border-gray-300 focus:ring-blue-500 focus:border-blue-500"}
          disabled:bg-gray-50 disabled:text-gray-500
        `,...s})}),re=({label:e,error:t,helperText:o,required:n,fullWidth:r,...s})=>m.jsx(E,{label:e,error:t,helperText:o,required:n,fullWidth:r,children:m.jsx("textarea",{className:`
          block rounded-md shadow-sm
          ${r?"w-full":"w-auto"}
          ${t?"border-red-500 focus:ring-red-500 focus:border-red-500":"border-gray-300 focus:ring-blue-500 focus:border-blue-500"}
          disabled:bg-gray-50 disabled:text-gray-500
        `,...s})}),ne=({label:e,error:t,helperText:o,required:n,fullWidth:r,children:s,...a})=>m.jsx(E,{label:e,error:t,helperText:o,required:n,fullWidth:r,children:m.jsx("select",{className:`
          block rounded-md shadow-sm
          ${r?"w-full":"w-auto"}
          ${t?"border-red-500 focus:ring-red-500 focus:border-red-500":"border-gray-300 focus:ring-blue-500 focus:border-blue-500"}
          disabled:bg-gray-50 disabled:text-gray-500
        `,...a,children:s})}),ae=({label:e,error:t,helperText:o,required:n,...r})=>m.jsx(E,{error:t,helperText:o,required:n,children:m.jsxs("div",{className:"flex items-center",children:[m.jsx("input",{type:"checkbox",className:`
            rounded border-gray-300 text-blue-600 shadow-sm
            focus:border-blue-300 focus:ring focus:ring-offset-0 focus:ring-blue-200 focus:ring-opacity-50
            ${t?"border-red-500":""}
          `,...r}),e&&m.jsxs("label",{className:"ml-2 block text-sm text-gray-900",children:[e,n&&m.jsx("span",{className:"text-red-500 ml-1",children:"*"})]})]})}),F=p.forwardRef(({children:e,variant:t="primary",size:o="md",isLoading:n=!1,loadingText:r,leftIcon:s,rightIcon:a,fullWidth:c=!1,disabled:l,className:d="",...g},f)=>{const x="inline-flex items-center justify-center font-medium rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 transition-colors",b={primary:"bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500",secondary:"bg-gray-200 text-gray-900 hover:bg-gray-300 focus:ring-gray-500",danger:"bg-red-600 text-white hover:bg-red-700 focus:ring-red-500",ghost:"text-gray-600 hover:bg-gray-100 focus:ring-gray-500"},w={sm:"px-3 py-1.5 text-sm",md:"px-4 py-2 text-base",lg:"px-6 py-3 text-lg"};return m.jsx(N.button,{ref:f,whileTap:{scale:.98},disabled:l||n,className:`
          ${x}
          ${b[t]}
          ${w[o]}
          ${c?"w-full":""}
          ${l||n?"opacity-60 cursor-not-allowed pointer-events-none":""}
          ${d}
        `,...g,children:n?m.jsxs(m.Fragment,{children:[m.jsx(k,{size:"sm",color:t==="secondary"||t==="ghost"?"gray":"white"}),r&&m.jsx("span",{className:"ml-2",children:r})]}):m.jsxs(m.Fragment,{children:[s&&m.jsx("span",{className:"mr-2",children:s}),e,a&&m.jsx("span",{className:"ml-2",children:a})]})})});F.displayName="Button";const K=p.forwardRef(({children:e,size:t="md",...o},n)=>{const r={sm:"p-1.5",md:"p-2",lg:"p-3"};return m.jsx(F,{ref:n,size:t,className:r[t],...o,children:e})});K.displayName="IconButton";export{F as B,ae as C,ne as S,oe as T,te as a,se as b,V as c,re as d,W as h,z as i,y as m,ee as r,Z as u};
