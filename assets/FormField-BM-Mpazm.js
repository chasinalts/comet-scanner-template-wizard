var F=Object.defineProperty;var L=(e,t,s)=>t in e?F(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var E=(e,t,s)=>L(e,typeof t!="symbol"?t+"":t,s);import{a as g}from"./vendor-react-Cmwg8GZL.js";import{s as S,h as z,S as v}from"./index-CJdPVH0m.js";import{j as h,m as N}from"./vendor-ui-Bq_-EsXc.js";class k{constructor(t=100){E(this,"cache");E(this,"maxSize");this.cache=new Map,this.maxSize=t}get(t){const s=this.cache.get(t);if(s){if(s.expiry&&Date.now()>s.expiry){this.cache.delete(t);return}return this.cache.delete(t),this.cache.set(t,s),s.value}}set(t,s,a=null){if(this.cache.size>=this.maxSize){const o=this.cache.keys().next().value;o&&this.cache.delete(o)}const n=a?Date.now()+a:null;this.cache.set(t,{value:s,expiry:n})}clear(){this.cache.clear()}}function b(e,t={}){const{maxCacheSize:s=100,ttl:a=null}=t,n=new k(s),o=(...r)=>{const i=JSON.stringify(r),l=n.get(i);if(l!==void 0)return l;const d=e(...r);return d instanceof Promise?(n.set(i,d,a),d.then(m=>(n.set(i,m,a),m)).catch(m=>{throw n.get(i)===d&&n.set(i,void 0,0),m})):(n.set(i,d,a),d)};return o.clearCache=()=>{n.clear()},o}const G=()=>{const[e,t]=g.useState([]);g.useEffect(()=>{const u=()=>{const y=localStorage.getItem("admin_contents");y&&t(JSON.parse(y))};u();const c=y=>{y.key==="admin_contents"&&u()};return window.addEventListener("storage",c),()=>window.removeEventListener("storage",c)},[]);const s=g.useMemo(()=>b(u=>u.filter(c=>c.type==="banner")),[]),a=g.useCallback(()=>{const u=s(e);if(u.length===0)return null;const c=u[u.length-1];return{id:c.id,src:c.imageUrl||"",alt:c.title,scale:c.scale,displayText:c.displayText}},[e,s]),n=g.useMemo(()=>b(u=>u.filter(c=>c.type==="scanner")),[]),o=g.useMemo(()=>b(u=>[...u].sort((c,y)=>y.updatedAt-c.updatedAt)),[]),r=g.useMemo(()=>b(u=>u.map(c=>({id:c.id,src:c.imageUrl||"",alt:c.title,scale:c.scale,displayText:c.displayText}))),[]),i=g.useCallback(()=>{const u=n(e),c=o(u);return r(c)},[e,n,o,r]),l=g.useMemo(()=>b(u=>u.filter(c=>c.type==="template")),[]),d=g.useMemo(()=>b(u=>u.map(c=>({id:c.id,title:c.title,code:c.content}))),[]),m=g.useCallback(()=>{const u=l(e),c=o(u);return d(c)},[e,l,o,d]),f=g.useMemo(()=>b(u=>u.filter(c=>c.type==="question")),[]),x=g.useMemo(()=>b(u=>u.map(c=>({id:c.id,title:c.title,text:c.content}))),[]),w=g.useCallback(()=>{const u=f(e),c=o(u);return x(c)},[e,f,o,x]);return g.useMemo(()=>({getBannerImage:a,getScannerImages:i,getTemplates:m,getQuestions:w,hasContent:e.length>0}),[a,i,m,w,e.length])},p=[];for(let e=0;e<256;++e)p.push((e+256).toString(16).slice(1));function O(e,t=0){return(p[e[t+0]]+p[e[t+1]]+p[e[t+2]]+p[e[t+3]]+"-"+p[e[t+4]]+p[e[t+5]]+"-"+p[e[t+6]]+p[e[t+7]]+"-"+p[e[t+8]]+p[e[t+9]]+"-"+p[e[t+10]]+p[e[t+11]]+p[e[t+12]]+p[e[t+13]]+p[e[t+14]]+p[e[t+15]]).toLowerCase()}let R;const M=new Uint8Array(16);function T(){if(!R){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");R=crypto.getRandomValues.bind(crypto)}return R(M)}const $=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),C={randomUUID:$};function P(e,t,s){if(C.randomUUID&&!e)return C.randomUUID();e=e||{};const a=e.random??e.rng?.()??T();if(a.length<16)throw new Error("Random bytes length must be >= 16");return a[6]=a[6]&15|64,a[8]=a[8]&63|128,O(a)}const j=async()=>{try{const{data:{user:e}}=await S.auth.getUser();if(!e)return!1;const{data:t,error:s}=await S.from("user_profiles").select("is_owner").eq("id",e.id).single();return s||!t?(console.error("Error checking owner status:",s),!1):t.is_owner===!0}catch(e){return console.error("Error checking owner status:",e),!1}},Q=async(e,t,s="public, max-age=31536000")=>{try{const a=z();if(!a)throw new Error("Authentication required. Please sign in to upload files.");if(!await j())throw new Error("You do not have permission to upload files. Only owners can upload media.");const o=e.name.split(".").pop(),r=`${P()}.${o}`,i=`${t}/${r}`,l=S.storage.from(v),{data:d,error:m}=await l.upload(i,e,{cacheControl:s,upsert:!1,contentType:e.type,duplex:"half",metadata:{userId:a}});if(m)throw console.error("Error uploading file to Supabase Storage:",m),m;const{data:{signedUrl:f}}=await S.storage.from(v).createSignedUrl(d.path,60*60*24*365);if(!f)throw new Error("Failed to generate signed URL for uploaded file");return console.log("File uploaded successfully to Supabase Storage:",f),f}catch(a){throw console.error("Error uploading file to Supabase Storage:",a),a}},q=async e=>{try{if(!z())throw new Error("Authentication required. Please sign in to delete files.");if(!await j())throw new Error("You do not have permission to delete files. Only owners can manage media.");const n=new URL(e).pathname.split("/"),o=n.findIndex(d=>d===v);if(o===-1||o===n.length-1){console.error("Invalid Supabase Storage URL format:",e);return}const r=n.slice(o+1).join("/"),i=S.storage.from(v),{error:l}=await i.remove([r]);if(l)throw console.error("Error deleting file from Supabase Storage:",l),l;console.log("File deleted successfully from Supabase Storage:",r)}catch(t){throw console.error("Error deleting file from Supabase Storage:",t),t}},D=async(e,t=1920,s=1080,a=.8)=>new Promise((n,o)=>{try{const r=new FileReader;r.onload=i=>{const l=new Image;l.onload=()=>{let d=l.width,m=l.height;if(d>t||m>s){const w=Math.min(t/d,s/m);d=Math.floor(d*w),m=Math.floor(m*w)}const f=document.createElement("canvas");f.width=d,f.height=m;const x=f.getContext("2d");if(!x){o(new Error("Could not get canvas context"));return}x.drawImage(l,0,0,d,m),f.toBlob(w=>{if(!w){o(new Error("Could not create blob from canvas"));return}const U=new File([w],e.name,{type:e.type,lastModified:Date.now()});console.log("Image compression results:",{originalSize:e.size,compressedSize:U.size,compressionRatio:(U.size/e.size*100).toFixed(2)+"%",dimensions:`${d}x${m}`}),n(U)},e.type,a)},l.onerror=()=>{o(new Error("Failed to load image for compression"))},typeof i.target?.result=="string"?l.src=i.target.result:o(new Error("Failed to read file"))},r.onerror=()=>{o(new Error("Failed to read file"))},r.readAsDataURL(e)}catch(r){o(r)}}),A=(e,t=1)=>{const s=t*1024*1024;return e.size>s},B=async(e,t={maxWidth:1920,maxHeight:1080,quality:.8,maxSizeInMB:1})=>{try{const s=A(e,t.maxSizeInMB)?t.quality:.92;return console.log(`Processing image with quality: ${s}`),await D(e,t.maxWidth,t.maxHeight,s)}catch(s){return console.error("Error processing image, using original:",s),e}},H=(e,t,s,a)=>{try{const n=URL.createObjectURL(e);(async()=>{try{const o=await B(e,{maxWidth:1920,maxHeight:1080,quality:.85,maxSizeInMB:1}),i=await Q(o,t);console.log("Image uploaded to Supabase:",{originalSize:e.size,processedSize:o.size,compressionRatio:(o.size/e.size*100).toFixed(2)+"%",imageUrl:i}),s(i,n),setTimeout(()=>{URL.revokeObjectURL(n)},5e3)}catch(o){if(console.error("Error in image processing or upload:",o),URL.revokeObjectURL(n),a)a(o);else throw o}})()}catch(n){if(console.error("Error in handleSupabaseImageUpload:",n),a)a(n);else throw n}},_=async(e,t=!1)=>{if(e.startsWith("blob:"))URL.revokeObjectURL(e);else if(t)try{e.includes("supabase")&&await q(e)}catch(s){console.error("Error deleting file from Supabase Storage:",s)}},X=(e,t,s)=>new Promise((a,n)=>{const o=new Image;o.src=URL.createObjectURL(e),o.onload=()=>{let r=o.width,i=o.height;r>t&&(i=i*t/r,r=t),i>s&&(r=r*s/i,i=s);const l=document.createElement("canvas");l.width=r,l.height=i;const d=l.getContext("2d");if(!d){n(new Error("Could not get canvas context"));return}d.drawImage(o,0,0,r,i),l.toBlob(m=>{m?a(m):n(new Error("Could not create blob from canvas"))},e.type),URL.revokeObjectURL(o.src)},o.onerror=()=>{n(new Error("Failed to load image")),URL.revokeObjectURL(o.src)}}),Z=()=>{const[e,t]=g.useState(()=>{const o=localStorage.getItem("admin_questions");return o?JSON.parse(o):[]});return g.useEffect(()=>{localStorage.setItem("admin_questions",JSON.stringify(e))},[e]),g.useEffect(()=>()=>{e.forEach(o=>{o.options?.forEach(r=>{r.imagePreview&&_(r.imagePreview)})})},[e]),{questions:e,setQuestions:t,addQuestion:o=>{const r={id:`question-${Date.now()}`,type:o,text:"",required:!1,...o==="choice"&&{options:[]},...o==="text"&&{placeholderVariable:""}};t(i=>[...i,r])},updateQuestion:(o,r)=>{t(i=>i.map(l=>l.id===o?{...l,...r}:l))},deleteQuestion:o=>{t(r=>r.filter(i=>i.id!==o))}}},W=()=>{const[e,t]=g.useState(()=>{const r=localStorage.getItem("admin_sections");return r?JSON.parse(r):[]});return g.useEffect(()=>{localStorage.setItem("admin_sections",JSON.stringify(e))},[e]),{sections:e,setSections:t,addSection:()=>{const r={id:`section-${Date.now()}`,title:"New Section",code:"",isMandatory:!1};t(i=>[...i,r])},updateSection:(r,i)=>{t(l=>l.map(d=>d.id===r?{...d,...i}:d))},deleteSection:r=>{t(i=>i.filter(l=>l.id!==r))},reorderSections:r=>{t(r)}}},I=({label:e,error:t,helperText:s,required:a,children:n,fullWidth:o=!1})=>h.jsxs("div",{className:`${o?"w-full":""} space-y-1`,children:[e&&h.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:[e,a&&h.jsx("span",{className:"text-red-500 ml-1",children:"*"})]}),h.jsx("div",{className:"mt-1",children:n}),(t||s)&&h.jsx("div",{className:"mt-1",children:t?h.jsx(N.p,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:"text-sm text-red-600",children:t}):s?h.jsx("p",{className:"text-sm text-gray-500",children:s}):null})]}),ee=({label:e,error:t,helperText:s,required:a,fullWidth:n,...o})=>h.jsx(I,{label:e,error:t,helperText:s,required:a,fullWidth:n,children:h.jsx("input",{className:`
          block rounded-md shadow-sm
          ${n?"w-full":"w-auto"}
          ${t?"border-red-500 focus:ring-red-500 focus:border-red-500":"border-gray-300 focus:ring-blue-500 focus:border-blue-500"}
          disabled:bg-gray-50 disabled:text-gray-500
        `,...o})}),te=({label:e,error:t,helperText:s,required:a,fullWidth:n,...o})=>h.jsx(I,{label:e,error:t,helperText:s,required:a,fullWidth:n,children:h.jsx("textarea",{className:`
          block rounded-md shadow-sm
          ${n?"w-full":"w-auto"}
          ${t?"border-red-500 focus:ring-red-500 focus:border-red-500":"border-gray-300 focus:ring-blue-500 focus:border-blue-500"}
          disabled:bg-gray-50 disabled:text-gray-500
        `,...o})}),oe=({label:e,error:t,helperText:s,required:a,fullWidth:n,children:o,...r})=>h.jsx(I,{label:e,error:t,helperText:s,required:a,fullWidth:n,children:h.jsx("select",{className:`
          block rounded-md shadow-sm
          ${n?"w-full":"w-auto"}
          ${t?"border-red-500 focus:ring-red-500 focus:border-red-500":"border-gray-300 focus:ring-blue-500 focus:border-blue-500"}
          disabled:bg-gray-50 disabled:text-gray-500
        `,...r,children:o})}),se=({label:e,error:t,helperText:s,required:a,...n})=>h.jsx(I,{error:t,helperText:s,required:a,children:h.jsxs("div",{className:"flex items-center",children:[h.jsx("input",{type:"checkbox",className:`
            rounded border-gray-300 text-blue-600 shadow-sm
            focus:border-blue-300 focus:ring focus:ring-offset-0 focus:ring-blue-200 focus:ring-opacity-50
            ${t?"border-red-500":""}
          `,...n}),e&&h.jsxs("label",{className:"ml-2 block text-sm text-gray-900",children:[e,a&&h.jsx("span",{className:"text-red-500 ml-1",children:"*"})]})]})});export{se as C,oe as S,ee as T,Z as a,W as b,_ as c,te as d,H as h,j as i,b as m,X as r,G as u};
